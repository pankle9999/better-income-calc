<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Better Income Calculator</title>
<style>
  body { font-family: Arial; background:#f4f4f4; padding:20px; }
  .container { background:white; padding:20px; max-width:700px; margin:auto; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
  input, button { padding:8px; margin:5px 0; width:100%; }
  table { width:100%; border-collapse: collapse; margin-top:15px; }
  th, td { border:1px solid #ccc; padding:6px; text-align:center; }
  th { background:#eee; }
</style>
</head>
<body>

<div class="container">
  <h2>Better Income Calculator</h2>

  <label>Existing Money</label>
  <input id="existing" type="number">

  <label>Weekly Add</label>
  <input id="weekly" type="number">

  <label>Weeks</label>
  <input id="weeks" type="number">

  <button onclick="calculate()">Calculate</button>
  <button onclick="loadLogs()">Load Logs</button>
  <button onclick="clearTable()">Clear Table</button>
  <button onclick="exportLogs()">Export Logs as JSON</button>

  <h3 id="result"></h3>

  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Week</th>
        <th>After 5% Loss</th>
        <th>After Weekly Add</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script type="module">
  // --- Firebase SDK ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

  // --- Your Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyC7cbWLzC90Tgvf6KueOURUKfkWXxUXmI4",
    authDomain: "money-calculator-b205c.firebaseapp.com",
    projectId: "money-calculator-b205c",
    storageBucket: "money-calculator-b205c.firebasestorage.app",
    messagingSenderId: "1082194101254",
    appId: "1:1082194101254:web:2115c50916683795e22f87",
    measurementId: "G-2VGW9684EB"
  };

  // --- Initialize Firebase ---
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;

  // --- Anonymous login ---
  signInAnonymously(auth)
    .catch(error => console.error("Auth error:", error));

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      console.log("Logged in anonymously:", user.uid);
    }
  });

  // --- Helper functions ---
  function addRow(ts, week, loss, add) {
    let row = document.createElement("tr");
    row.innerHTML = `<td>${ts}</td><td>${week}</td><td>${loss}</td><td>${add}</td>`;
    document.getElementById("tableBody").appendChild(row);
  }

  function clearTableInternal() {
    document.getElementById("tableBody").innerHTML = "";
  }

  async function saveLogInternal(log) {
    if (!currentUser) { alert("User not logged in yet."); return; }
    log.userId = currentUser.uid; // Save logs per user
    try {
      await addDoc(collection(db, "logs"), log);
      console.log("Log saved successfully!");
    } catch(e) {
      console.error("Error saving log:", e);
    }
  }

  async function loadLogsInternal() {
    if (!currentUser) { alert("User not logged in yet."); return; }
    clearTableInternal();
    try {
      const q = query(collection(db, "logs"), where("userId", "==", currentUser.uid));
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach(doc => {
        const log = doc.data();
        log.weeks.forEach(w => addRow(log.timestamp, w.week, w.afterLoss, w.afterAdd));
      });
    } catch(e) {
      console.error("Error loading logs:", e);
    }
  }

  async function exportLogsInternal() {
    if (!currentUser) { alert("User not logged in yet."); return; }
    try {
      const q = query(collection(db, "logs"), where("userId", "==", currentUser.uid));
      const querySnapshot = await getDocs(q);
      let allLogs = [];
      querySnapshot.forEach(doc => allLogs.push(doc.data()));

      const jsonStr = JSON.stringify(allLogs, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "money_logs.json";
      a.click();
      URL.revokeObjectURL(url);
    } catch(e) {
      console.error("Error exporting logs:", e);
    }
  }

  // --- Global functions for buttons ---
  window.clearTable = function() { clearTableInternal(); };
  window.loadLogs = async function() { await loadLogsInternal(); };
  window.exportLogs = async function() { await exportLogsInternal(); };

  window.calculate = async function() {
    if (!currentUser) { alert("User not logged in yet."); return; }

    let existing = Number(document.getElementById("existing").value);
    let weekly = Number(document.getElementById("weekly").value);
    let weeks = Number(document.getElementById("weeks").value);

    if (!existing || !weekly || !weeks) {
      alert("Enter valid numbers");
      return;
    }

    let log = { timestamp: new Date().toLocaleString(), weeks: [] };

    for (let i = 1; i <= weeks; i++) {
      let afterLoss = Math.ceil(existing * 0.95);
      let afterAdd = afterLoss + weekly;
      log.weeks.push({ week: i, afterLoss, afterAdd });
      addRow(log.timestamp, i, afterLoss, afterAdd);
      existing = afterAdd;
    }

    document.getElementById("result").innerText = "Final Money: " + existing;
    await saveLogInternal(log);
  };
</script>

</body>
</html>
