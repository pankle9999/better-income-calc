<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Better Income Calculator</title>

<style>
:root {
  --bg: #f4f4f4;
  --fg: #111;
  --card: #fff;
}

body.dark {
  --bg: #121212;
  --fg: #eee;
  --card: #1e1e1e;
}

body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--fg);
}

.container {
  max-width: 900px;
  margin: 40px auto;
  padding: 20px;
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.1);
  position: relative;
}

h1 { margin-top: 0; }

input, button {
  padding: 10px;
  margin: 5px 0;
  width: 100%;
  font-size: 1rem;
  border-radius:6px;
  border:1px solid #ccc;
}

button {
  cursor: pointer;
  border: none;
  background: #4caf50;
  color:white;
  font-weight:bold;
}

button:hover { opacity:0.9; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border-bottom: 1px solid #ccc;
  padding: 8px;
  text-align: right;
}

th { text-align: center; }

#darkModeBtn, #adminLoginBtn {
  position: fixed;
  top: 12px;
  font-size: 1.3rem;
  cursor:pointer;
  z-index:10;
}

#darkModeBtn { right: 60px; background: transparent; color: var(--fg); border:none; }
#adminLoginBtn { right: 12px; background: #ff7f50; border:none; color:white; }
</style>
</head>

<body>

<button id="darkModeBtn">ðŸŒ™</button>
<button id="adminLoginBtn">Admin</button>

<div class="container">
  <h1>Better Income Calculator</h1>

  <label>Existing Money</label>
  <input id="existing" placeholder="e.g. 1,000 or 1000">

  <label>Weekly Income</label>
  <input id="weekly" placeholder="e.g. 500">

  <label>Weeks</label>
  <input id="weeks" type="number">

  <label>Last Paid Date (optional)</label>
  <input id="lastPaid" type="date">

  <div class="button-row">
    <button id="calcBtn">Calculate</button>
    <button id="loadBtn">Load Logs</button>
    <button id="exportBtn">Export Logs</button>
  </div>

  <h2 id="result"></h2>

  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Time</th>
        <th>Week</th>
        <th>After 5%</th>
        <th>Weekly (-10%)</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ---------- FIREBASE ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyC7cbWLzC90Tgvf6KueOURUKfkWXxUXmI4",
  authDomain: "money-calculator-b205c.firebaseapp.com",
  projectId: "money-calculator-b205c",
  storageBucket: "money-calculator-b205c.firebasestorage.app",
  messagingSenderId: "1082194101254",
  appId: "1:1082194101254:web:2115c50916683795e22f87"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- STATE ---------- */
let currentUser = "guest_" + Math.random().toString(36).slice(2);
let isAdmin = false;

/* ---------- DOM ---------- */
const existingEl = document.getElementById("existing");
const weeklyEl = document.getElementById("weekly");
const weeksEl = document.getElementById("weeks");
const lastPaidEl = document.getElementById("lastPaid");
const rowsEl = document.getElementById("rows");
const resultEl = document.getElementById("result");
const calcBtn = document.getElementById("calcBtn");
const loadBtn = document.getElementById("loadBtn");
const exportBtn = document.getElementById("exportBtn");
const darkBtn = document.getElementById("darkModeBtn");
const adminBtn = document.getElementById("adminLoginBtn");

/* ---------- HELPERS ---------- */
function parseMoney(val) {
  if(!val) return 0;
  val = val.replace(/[.,](?=.*[.,])/g,'');
  val = val.replace(/,/g,'');
  return Math.floor(Number(val));
}

function fmt(n) { return n.toLocaleString("en-GB"); }

function clearTable() { rowsEl.innerHTML = ""; }

function addRow(u,t,w,a,wa,total){
  const tr = document.createElement("tr");
  tr.innerHTML = `<td>${u}</td><td>${t}</td><td>${w}</td><td>${fmt(a)}</td><td>${fmt(wa)}</td><td>${fmt(total)}</td>`;
  rowsEl.appendChild(tr);
}

/* ---------- DATE â†’ WEEKS ---------- */
lastPaidEl.addEventListener("change", ()=>{
  if(!lastPaidEl.value) return;
  const d1 = new Date(lastPaidEl.value);
  const d2 = new Date();
  const days = Math.floor((d2-d1)/86400000);
  let calcWeeks = days % 7 >= 4 ? Math.floor(days/7)+1 : Math.floor(days/7);
  weeksEl.value = Math.max(0,calcWeeks);
});

/* ---------- CALCULATE ---------- */
async function calculate(){
  clearTable();
  let existing = parseMoney(existingEl.value);
  let weekly = parseMoney(weeklyEl.value);
  let weeks = Number(weeksEl.value);

  if(!existing || !weekly || !weeks){ alert("Invalid input"); return; }

  const log = { username:currentUser, timestamp:new Date().toLocaleString(), weeks:[] };
  const weeklyAdj = Math.ceil(weekly*0.9);

  for(let i=1;i<=weeks;i++){
    const afterLoss = Math.ceil(existing*0.95);
    const total = afterLoss+weeklyAdj;
    addRow(currentUser, log.timestamp, i, afterLoss, weeklyAdj, total);
    log.weeks.push({week:i, afterLoss, weeklyAdj, total});
    existing = total;
  }

  resultEl.textContent = "Final Money: "+fmt(existing);
  await addDoc(collection(db,"logs"), log);
}

/* ---------- LOAD LOGS ---------- */
async function loadLogs(){
  clearTable();
  const q = isAdmin
    ? collection(db,"logs")
    : query(collection(db,"logs"), where("username","==",currentUser));
  const snap = await getDocs(q);
  snap.forEach(d=> d.data().weeks.forEach(w=>{
    addRow(d.data().username,d.data().timestamp,w.week,w.afterLoss,w.weeklyAdj,w.total);
  }));
}

/* ---------- EXPORT LOGS ---------- */
async function exportLogs(){
  const q = isAdmin
    ? collection(db,"logs")
    : query(collection(db,"logs"), where("username","==",currentUser));
  const snap = await getDocs(q);
  const data = [];
  snap.forEach(d=> data.push(d.data()));
  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = isAdmin ? "ALL_LOGS.json" : `${currentUser}_logs.json`;
  a.click();
}

/* ---------- DARK MODE ---------- */
function updateDarkIcon(){ darkBtn.textContent = document.body.classList.contains("dark") ? "â˜€ï¸":"ðŸŒ™"; }
darkBtn.onclick = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode",document.body.classList.contains("dark")?"on":"off");
  updateDarkIcon();
};
if(localStorage.getItem("darkMode")==="on"){document.body.classList.add("dark");}
updateDarkIcon();

/* ---------- ADMIN LOGIN ---------- */
adminBtn.onclick = ()=>{
  const u = prompt("Admin username:");
  if(u==="Ec0n0mySt4ff0nT0p"){ currentUser=u; isAdmin=true; alert("Admin logged in"); }
  else alert("Incorrect admin username");
};

/* ---------- BUTTONS ---------- */
calcBtn.onclick = calculate;
loadBtn.onclick = loadLogs;
exportBtn.onclick = exportLogs;
</script>

</body>
</html>
