<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Better Income Calculator</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #eef2f7;
  margin: 0;
  transition: background 0.3s, color 0.3s;
}

.container {
  max-width: 900px;
  background: white;
  margin: 40px auto;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  position: relative;
  transition: background 0.3s;
}

h2 { text-align: center; }

label {
  display:block;
  margin-top:12px;
}

input {
  width:100%;
  padding:10px;
  margin-top:4px;
  border-radius:6px;
  border:1px solid #ccc;
}

button {
  padding:10px;
  border:none;
  border-radius:6px;
  background:#4a90e2;
  color:white;
  font-weight:bold;
  cursor:pointer;
}

.button-row {
  display:flex;
  gap:10px;
  margin-top:15px;
  flex-wrap:wrap;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

th, td {
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
}

th {
  background:#f5f5f5;
}

#result {
  text-align:center;
  font-size:1.3em;
  margin-top:15px;
}

/* Corner buttons */
#adminLoginBtn {
  position:absolute;
  top:20px;
  right:20px;
  background:#ff7f50;
}

#darkModeBtn {
  position:absolute;
  top:20px;
  left:20px;
  background:#222;
  color:white;
  font-size:18px;
}

/* DARK MODE */
body.dark {
  background:#121212;
  color:#eaeaea;
}

body.dark .container {
  background:#1e1e1e;
}

body.dark input {
  background:#2a2a2a;
  color:white;
  border:1px solid #444;
}

body.dark th {
  background:#333;
}

body.dark td {
  background:#1e1e1e;
}

body.dark button {
  background:#5a9bff;
}

body.dark #adminLoginBtn {
  background:#ff6a3d;
}
</style>
</head>

<body>
<div class="container">
  <h2>Better Income Calculator</h2>

  <button id="darkModeBtn">ðŸŒ™</button>
  <button id="adminLoginBtn">Admin Login</button>

  <label>Existing Money</label>
  <input id="existing" placeholder="1,000 or 1.000">

  <label>Weekly Add</label>
  <input id="weekly" placeholder="500">

  <label>Weeks</label>
  <input id="weeks" type="number">

  <label>Last Payment Date (optional)</label>
  <input type="date" id="lastPayment">

  <div class="button-row">
    <button id="calcBtn">Calculate</button>
    <button id="loadBtn">Load Logs</button>
    <button id="exportBtn">Export Logs</button>
  </div>

  <div id="result"></div>

  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Time</th>
        <th>Week</th>
        <th>After 5%</th>
        <th>Weekly (-10%)</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ---------- FIREBASE ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyC7cbWLzC90Tgvf6KueOURUKfkWXxUXmI4",
  authDomain: "money-calculator-b205c.firebaseapp.com",
  projectId: "money-calculator-b205c",
  storageBucket: "money-calculator-b205c.firebasestorage.app",
  messagingSenderId: "1082194101254",
  appId: "1:1082194101254:web:2115c50916683795e22f87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- STATE ---------- */
let currentUser = "guest_" + Math.random().toString(36).slice(2);
let isAdmin = false;

/* ---------- DOM ---------- */
const existingInput = document.getElementById("existing");
const weeklyInput = document.getElementById("weekly");
const weeksInput = document.getElementById("weeks");
const lastPaymentInput = document.getElementById("lastPayment");
const tableBody = document.getElementById("tableBody");
const resultDiv = document.getElementById("result");
const darkBtn = document.getElementById("darkModeBtn");

/* ---------- HELPERS ---------- */
function parseMoney(val) {
  if (!val) return 0;
  val = val.replace(/[.,](?=.*[.,])/g, "");
  val = val.replace(/,/g, ".");
  return Math.floor(Number(val));
}

function fmt(n) {
  return n.toLocaleString("en-GB");
}

function clearTable() {
  tableBody.innerHTML = "";
}

function addRow(u, t, w, a, wa, tot) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${u}</td>
    <td>${t}</td>
    <td>${w}</td>
    <td>${fmt(a)}</td>
    <td>${fmt(wa)}</td>
    <td>${fmt(tot)}</td>`;
  tableBody.appendChild(tr);
}

/* ---------- AUTO WEEKS ---------- */
lastPaymentInput.addEventListener("change", () => {
  if (!lastPaymentInput.value) return;

  const from = new Date(lastPaymentInput.value);
  const now = new Date();
  const days = Math.floor((now - from) / 86400000);

  let calcWeeks =
    days % 7 >= 4 ? Math.floor(days / 7) + 1 : Math.floor(days / 7);

  weeksInput.value = Math.max(0, calcWeeks);
});

/* ---------- CALCULATE ---------- */
async function calculate() {
  clearTable();

  let existing = parseMoney(existingInput.value);
  let weekly = parseMoney(weeklyInput.value);
  let weeks = Number(weeksInput.value);

  if (!existing || !weekly || !weeks) {
    alert("Invalid input");
    return;
  }

  const log = {
    username: currentUser,
    timestamp: new Date().toLocaleString(),
    weeks: []
  };

  for (let i = 1; i <= weeks; i++) {
    let afterLoss = Math.ceil(existing * 0.95);
    let weeklyAdj = Math.ceil(weekly * 0.9);
    let total = afterLoss + weeklyAdj;

    log.weeks.push({ week: i, afterLoss, weeklyAdj, total });
    addRow(currentUser, log.timestamp, i, afterLoss, weeklyAdj, total);

    existing = total;
  }

  resultDiv.textContent = "Final Money: " + fmt(existing);
  await addDoc(collection(db, "logs"), log);
}

/* ---------- LOGS ---------- */
async function loadLogs() {
  clearTable();
  const q = isAdmin
    ? collection(db, "logs")
    : query(collection(db, "logs"), where("username", "==", currentUser));

  const snap = await getDocs(q);
  snap.forEach(d => {
    d.data().weeks.forEach(w =>
      addRow(d.data().username, d.data().timestamp, w.week, w.afterLoss, w.weeklyAdj, w.total)
    );
  });
}

async function exportLogs() {
  const q = isAdmin
    ? collection(db, "logs")
    : query(collection(db, "logs"), where("username", "==", currentUser));

  const snap = await getDocs(q);
  const data = [];
  snap.forEach(d => data.push(d.data()));

  const blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = isAdmin ? "ALL_LOGS.json" : `${currentUser}_logs.json`;
  a.click();
}

/* ---------- DARK MODE ---------- */
function updateDarkIcon() {
  darkBtn.textContent = document.body.classList.contains("dark") ? "â˜€ï¸" : "ðŸŒ™";
}

darkBtn.onclick = () => {
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark") ? "on" : "off");
  updateDarkIcon();
};

if (localStorage.getItem("darkMode") === "on") {
  document.body.classList.add("dark");
}
updateDarkIcon();

/* ---------- ADMIN ---------- */
document.getElementById("adminLoginBtn").onclick = () => {
  const u = prompt("Admin username:");
  if (u === "Ec0n0mySt4ff0nT0p") {
    currentUser = u;
    isAdmin = true;
    alert("Admin logged in");
  } else {
    alert("Incorrect admin username");
  }
};

/* ---------- BUTTON WIRING ---------- */
document.getElementById("calcBtn").onclick = calculate;
document.getElementById("loadBtn").onclick = loadLogs;
document.getElementById("exportBtn").onclick = exportLogs;
</script>
</body>
</html>
